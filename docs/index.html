<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Resume Keyword Matcher</title>
  <style>
    body { font-family: system-ui, Arial; margin: 24px; line-height: 1.4; }
    h1 { margin-bottom: 6px; }
    .muted { color: #555; margin-top: 0; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px; }
    textarea { width: 100%; min-height: 240px; padding: 10px; font-size: 14px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-top: 12px; }
    button { padding: 10px 14px; font-size: 14px; cursor: pointer; }
    input[type="number"] { width: 70px; padding: 8px; }
    label { display: flex; gap: 8px; align-items: center; }
    .cards { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 16px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; }
    .pill { display: inline-block; padding: 4px 8px; border-radius: 999px; font-size: 12px; margin: 4px 6px 0 0; border: 1px solid #ddd; }
    .ok { border-color: #b7e4c7; background: #ecfdf3; }
    .no { border-color: #ffccd5; background: #fff0f3; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .score { font-size: 22px; font-weight: 700; }
    .small { font-size: 12px; color: #666; }
    .warn { color: #7c2d12; background:#fff7ed; border:1px solid #fed7aa; padding:10px; border-radius:10px; }
    .success { color: #14532d; background:#f0fdf4; border:1px solid #bbf7d0; padding:10px; border-radius:10px; }
    .spinner { display:inline-block; width:14px; height:14px; border:2px solid #ccc; border-top-color:#333; border-radius:50%; animation:spin 1s linear infinite; vertical-align:middle; }
    @keyframes spin { to { transform:rotate(360deg); } }
    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
      .cards { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <h1>Resume Keyword Matcher</h1>
  <p class="muted">Paste a job description and your resume. This finds important terms from the job post and checks which ones appear in your resume.</p>

  <div class="warn">
    <b>Backend required:</b> This site (GitHub Pages) calls your Render API for analysis + PDF upload + AI suggestions.
    <div class="small">If buttons do nothing, make sure API_BASE is correct and your Render service is live.</div>
  </div>

  <div class="grid">
    <div>
      <h3>Job Description</h3>
      <textarea id="jd" placeholder="Paste the job description here..."></textarea>
    </div>
    <div>
      <h3>Resume</h3>
      <textarea id="resume" placeholder="Paste your resume here..."></textarea>

      <div style="margin-top:10px;">
        <label class="small" style="display:block; margin-bottom:6px;">Or upload resume PDF</label>
        <input id="resumePdf" type="file" accept="application/pdf" />
        <div class="small">PDF upload uses your backend to extract text.</div>
      </div>
    </div>
  </div>

  <div class="row">
    <button id="analyzeBtn">Analyze</button>
    <button id="aiBtn">Get AI Suggestions</button>
    <button id="clearBtn">Clear</button>
    <button id="copyMissingBtn">Copy Missing</button>

    <label>
      Min word length:
      <input id="minLen" type="number" min="2" max="20" value="3"/>
    </label>

    <label>
      Top keywords:
      <input id="topN" type="number" min="10" max="200" value="40"/>
    </label>

    <label>
      <input id="includeBigrams" type="checkbox" checked />
      Include 2-word phrases
    </label>
  </div>

  <div class="cards">
    <div class="card">
      <div class="small">Match Score</div>
      <div class="score" id="score">‚Äî</div>
      <div class="small" id="scoreDetail"></div>
    </div>

    <div class="card">
      <div class="small">Found</div>
      <div class="mono" id="foundCount">‚Äî</div>
    </div>

    <div class="card">
      <div class="small">Missing</div>
      <div class="mono" id="missingCount">‚Äî</div>
    </div>
  </div>

  <div class="grid" style="margin-top:16px;">
    <div class="card">
      <h3 style="margin-top:0;">‚úÖ Found Keywords</h3>
      <div id="foundList"></div>
    </div>
    <div class="card">
      <h3 style="margin-top:0;">‚ùå Missing Keywords</h3>
      <div id="missingList"></div>
    </div>
  </div>

  <div class="card" style="margin-top:16px;">
    <h3 style="margin-top:0;">ü§ñ AI Suggestions</h3>
    <div class="small" style="margin-bottom:10px;">
      Uses ChatGPT to recommend improvements + bullet rewrites. (Requires OPENAI_API_KEY set on your backend.)
    </div>
    <div id="aiStatus" class="small"></div>
    <div id="aiOut" style="margin-top:10px;"></div>
  </div>

<script>
  // ‚úÖ IMPORTANT: Put your Render backend base URL here (NO trailing slash)
  // Example: https://resume-matcher-whj0.onrender.com
  const API_BASE = "https://resume-matcher-whj0.onrender.com";

  window.__missingTerms = [];

  // -------------------------
  // UI helpers
  // -------------------------
  function makePills(container, items, className) {
    container.innerHTML = "";
    if (!items.length) {
      container.innerHTML = `<div class="small">No items.</div>`;
      return;
    }
    for (const term of items) {
      const span = document.createElement("span");
      span.className = `pill ${className}`;
      span.textContent = term;
      container.appendChild(span);
    }
  }

  function setStatus(el, html) {
    el.innerHTML = html || "";
  }

  function escapeHtml(s) {
    return (s || "").replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  // -------------------------
  // Backend calls
  // -------------------------
  async function analyzeViaBackendText() {
    const jdRaw = document.getElementById("jd").value;
    const resumeRaw = document.getElementById("resume").value;

    const minLen = parseInt(document.getElementById("minLen").value, 10) || 3;
    const topN = parseInt(document.getElementById("topN").value, 10) || 40;
    const includeBigrams = document.getElementById("includeBigrams").checked;

    const res = await fetch(`${API_BASE}/analyze`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ jd: jdRaw, resume: resumeRaw, minLen, topN, includeBigrams })
    });
    if (!res.ok) throw new Error("Analyze failed");
    return await res.json();
  }

  async function analyzeViaBackendPdf() {
    const jdRaw = document.getElementById("jd").value;

    const minLen = parseInt(document.getElementById("minLen").value, 10) || 3;
    const topN = parseInt(document.getElementById("topN").value, 10) || 40;
    const includeBigrams = document.getElementById("includeBigrams").checked;

    const pdfFile = document.getElementById("resumePdf").files[0];
    if (!pdfFile) throw new Error("No PDF selected");

    const form = new FormData();
    form.append("jd", jdRaw);
    form.append("minLen", String(minLen));
    form.append("topN", String(topN));
    form.append("includeBigrams", String(includeBigrams));
    form.append("resume_pdf", pdfFile);

    const res = await fetch(`${API_BASE}/analyze_pdf`, { method:"POST", body: form });
    if (!res.ok) throw new Error("Analyze PDF failed");
    return await res.json();
  }

  function renderAnalyzeResult(data) {
    const found = data.found || [];
    const missing = data.missing || [];
    const total = (data.keywords || []).length || (found.length + missing.length) || 1;
    const scorePct = data.scorePct ?? Math.round((found.length / total) * 100);

    document.getElementById("score").textContent = `${scorePct}%`;
    document.getElementById("scoreDetail").textContent = `${found.length} / ${total} key terms matched`;

    document.getElementById("foundCount").textContent = found.length;
    document.getElementById("missingCount").textContent = missing.length;

    makePills(document.getElementById("foundList"), found, "ok");
    makePills(document.getElementById("missingList"), missing, "no");

    window.__missingTerms = missing;
  }

  async function analyze() {
    const pdfFile = document.getElementById("resumePdf").files[0];
    const jdRaw = document.getElementById("jd").value.trim();
    const resumeRaw = document.getElementById("resume").value.trim();

    if (!jdRaw) return alert("Paste a Job Description first.");

    // If PDF is selected, use it. Else use textarea resume.
    if (pdfFile) {
      const data = await analyzeViaBackendPdf();
      renderAnalyzeResult(data);
      return;
    }
    if (!resumeRaw) return alert("Paste your resume OR upload a PDF.");
    const data = await analyzeViaBackendText();
    renderAnalyzeResult(data);
  }

  async function getAiSuggestions() {
    const aiStatus = document.getElementById("aiStatus");
    const aiOut = document.getElementById("aiOut");

    const jd = document.getElementById("jd").value.trim();
    let resume = document.getElementById("resume").value.trim();

    if (!jd) return alert("Paste a Job Description first.");

    // If user uploaded PDF and resume textarea is empty, it's okay ‚Äî they can still click after Analyze.
    // But AI endpoint needs resume text; easiest path: require resume text present OR tell them to paste it.
    if (!resume) {
      // If they already analyzed with PDF, they might not have resume text. Tell them:
      alert("For AI Suggestions: paste your resume text in the Resume box (or add a 'extract+fill' feature next).");
      return;
    }

    setStatus(aiStatus, `<span class="spinner"></span> Generating suggestions...`);
    aiOut.innerHTML = "";

    const payload = {
      jd,
      resume,
      missing: window.__missingTerms || [],
      level: "intern",
      tone: "confident",
      max_bullets: 6
    };

    const res = await fetch(`${API_BASE}/suggest`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      setStatus(aiStatus, `<div class="warn">AI request failed. Check your backend logs on Render.</div>`);
      return;
    }

    // Backend returns { ok: true, data: {...} } OR an error object
    if (data.error) {
      setStatus(aiStatus, `<div class="warn"><b>${escapeHtml(data.error)}</b><br><span class="small">${escapeHtml(data.how_to_fix || "")}</span></div>`);
      return;
    }

    setStatus(aiStatus, `<div class="success">Done ‚úÖ</div>`);

    const out = data.data || {};
    if (out.raw) {
      aiOut.innerHTML = `<pre class="mono" style="white-space:pre-wrap;">${escapeHtml(out.raw)}</pre>`;
      return;
    }

    // Pretty render JSON keys
    aiOut.innerHTML = `
      <div><b>${escapeHtml(out.headline || "Suggestions")}</b></div>
      <div style="margin-top:8px;"><b>Overall feedback</b><div class="small">${escapeHtml(out.overall_feedback || "")}</div></div>

      <div style="margin-top:10px;"><b>Top gaps</b>
        <ul class="small">
          ${(out.top_gaps || []).map(x => `<li>${escapeHtml(x)}</li>`).join("")}
        </ul>
      </div>

      <div style="margin-top:10px;"><b>Keyword plan</b>
        <ul class="small">
          ${(out.keyword_plan || []).map(x => `<li>${escapeHtml(x)}</li>`).join("")}
        </ul>
      </div>

      <div style="margin-top:10px;"><b>Rewrite examples</b>
        ${(out.rewrite_examples || []).map(pair => `
          <div class="card" style="margin-top:8px;">
            <div class="small"><b>BEFORE</b></div>
            <div class="mono" style="white-space:pre-wrap;">${escapeHtml(pair.before || "")}</div>
            <div class="small" style="margin-top:6px;"><b>AFTER</b></div>
            <div class="mono" style="white-space:pre-wrap;">${escapeHtml(pair.after || "")}</div>
            <div class="small" style="margin-top:6px;"><b>Why</b> ${escapeHtml(pair.why_it_works || "")}</div>
          </div>
        `).join("")}
      </div>

      <div style="margin-top:10px;"><b>ATS checks</b>
        <ul class="small">
          ${(out.ats_checks || []).map(x => `<li>${escapeHtml(x)}</li>`).join("")}
        </ul>
      </div>

      <div style="margin-top:10px;"><b>Next steps</b>
        <ol class="small">
          ${(out.next_steps || []).map(x => `<li>${escapeHtml(x)}</li>`).join("")}
        </ol>
      </div>
    `;
  }

  // -------------------------
  // Events
  // -------------------------
  document.getElementById("analyzeBtn").addEventListener("click", async () => {
    try {
      await analyze();
    } catch (e) {
      alert("Analyze failed. Check API_BASE and Render logs.");
      console.error(e);
    }
  });

  document.getElementById("aiBtn").addEventListener("click", async () => {
    try {
      await getAiSuggestions();
    } catch (e) {
      alert("AI suggestions failed. Check Render logs + OPENAI_API_KEY.");
      console.error(e);
    }
  });

  document.getElementById("clearBtn").addEventListener("click", () => {
    document.getElementById("jd").value = "";
    document.getElementById("resume").value = "";
    document.getElementById("resumePdf").value = "";
    document.getElementById("score").textContent = "‚Äî";
    document.getElementById("scoreDetail").textContent = "";
    document.getElementById("foundCount").textContent = "‚Äî";
    document.getElementById("missingCount").textContent = "‚Äî";
    document.getElementById("foundList").innerHTML = "";
    document.getElementById("missingList").innerHTML = "";
    document.getElementById("aiStatus").innerHTML = "";
    document.getElementById("aiOut").innerHTML = "";
    window.__missingTerms = [];
  });

  document.getElementById("copyMissingBtn").addEventListener("click", async () => {
    const missing = window.__missingTerms || [];
    const text = missing.join("\n");
    if (!text) {
      alert("No missing terms to copy yet.");
      return;
    }
    try {
      await navigator.clipboard.writeText(text);
      alert("Missing terms copied!");
    } catch (e) {
      alert("Clipboard failed. You can manually select and copy from the Missing list.");
    }
  });
</script>
</body>
</html>
